<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.5.0">
<meta name="crystal_docs.project_version" content="master">
<meta name="crystal_docs.project_name" content="triki">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="triki">
  <title>triki master</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          triki
        </a>
      </h1>

      <span class="project-version">
        master
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="triki/Triki" data-name="triki">
      <a href="Triki.html">Triki</a>
      
        <ul>
  
  <li class=" " data-id="triki/Triki/Between" data-name="triki::between">
      <a href="Triki/Between.html">Between</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ColumnAction" data-name="triki::columnaction">
      <a href="Triki/ColumnAction.html">ColumnAction</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ColumnList" data-name="triki::columnlist">
      <a href="Triki/ColumnList.html">ColumnList</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ColumnName" data-name="triki::columnname">
      <a href="Triki/ColumnName.html">ColumnName</a>
      
    </li>
  
  <li class="parent " data-id="triki/Triki/ConfigApplicator" data-name="triki::configapplicator">
      <a href="Triki/ConfigApplicator.html">ConfigApplicator</a>
      
        <ul>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/BoolProc" data-name="triki::configapplicator::boolproc">
      <a href="Triki/ConfigApplicator/BoolProc.html">BoolProc</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/Columns" data-name="triki::configapplicator::columns">
      <a href="Triki/ConfigApplicator/Columns.html">Columns</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/IntRange" data-name="triki::configapplicator::intrange">
      <a href="Triki/ConfigApplicator/IntRange.html">IntRange</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/Row" data-name="triki::configapplicator::row">
      <a href="Triki/ConfigApplicator/Row.html">Row</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/RowAsHash" data-name="triki::configapplicator::rowashash">
      <a href="Triki/ConfigApplicator/RowAsHash.html">RowAsHash</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/RowContent" data-name="triki::configapplicator::rowcontent">
      <a href="Triki/ConfigApplicator/RowContent.html">RowContent</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigApplicator/StringProc" data-name="triki::configapplicator::stringproc">
      <a href="Triki/ConfigApplicator/StringProc.html">StringProc</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigColumn" data-name="triki::configcolumn">
      <a href="Triki/ConfigColumn.html">ConfigColumn</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigColumnHash" data-name="triki::configcolumnhash">
      <a href="Triki/ConfigColumnHash.html">ConfigColumnHash</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigHash" data-name="triki::confighash">
      <a href="Triki/ConfigHash.html">ConfigHash</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigParser" data-name="triki::configparser">
      <a href="Triki/ConfigParser.html">ConfigParser</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigScaffoldGenerator" data-name="triki::configscaffoldgenerator">
      <a href="Triki/ConfigScaffoldGenerator.html">ConfigScaffoldGenerator</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigTable" data-name="triki::configtable">
      <a href="Triki/ConfigTable.html">ConfigTable</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/ConfigTableHash" data-name="triki::configtablehash">
      <a href="Triki/ConfigTableHash.html">ConfigTableHash</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/CopyStatementParser" data-name="triki::copystatementparser">
      <a href="Triki/CopyStatementParser.html">CopyStatementParser</a>
      
    </li>
  
  <li class="parent " data-id="triki/Triki/DictionaryInterface" data-name="triki::dictionaryinterface">
      <a href="Triki/DictionaryInterface.html">DictionaryInterface</a>
      
        <ul>
  
  <li class=" " data-id="triki/Triki/DictionaryInterface/ClassMethods" data-name="triki::dictionaryinterface::classmethods">
      <a href="Triki/DictionaryInterface/ClassMethods.html">ClassMethods</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="triki/Triki/EnglishDictionary" data-name="triki::englishdictionary">
      <a href="Triki/EnglishDictionary.html">EnglishDictionary</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/Faker" data-name="triki::faker">
      <a href="Triki/Faker.html">Faker</a>
      
    </li>
  
  <li class="parent " data-id="triki/Triki/FakerInterface" data-name="triki::fakerinterface">
      <a href="Triki/FakerInterface.html">FakerInterface</a>
      
        <ul>
  
  <li class=" " data-id="triki/Triki/FakerInterface/ClassMethods" data-name="triki::fakerinterface::classmethods">
      <a href="Triki/FakerInterface/ClassMethods.html">ClassMethods</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="triki/Triki/InsertStatementParser" data-name="triki::insertstatementparser">
      <a href="Triki/InsertStatementParser.html">InsertStatementParser</a>
      
    </li>
  
  <li class="parent " data-id="triki/Triki/Mysql" data-name="triki::mysql">
      <a href="Triki/Mysql.html">Mysql</a>
      
        <ul>
  
  <li class=" " data-id="triki/Triki/Mysql/Field" data-name="triki::mysql::field">
      <a href="Triki/Mysql/Field.html">Field</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="triki/Triki/Postgres" data-name="triki::postgres">
      <a href="Triki/Postgres.html">Postgres</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/SqlServer" data-name="triki::sqlserver">
      <a href="Triki/SqlServer.html">SqlServer</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/TableName" data-name="triki::tablename">
      <a href="Triki/TableName.html">TableName</a>
      
    </li>
  
  <li class=" " data-id="triki/Triki/TruncateOrKeepTable" data-name="triki::truncateorkeeptable">
      <a href="Triki/TruncateOrKeepTable.html">TruncateOrKeepTable</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="triki" class="anchor" href="#triki">  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Triki</h1>
<p><a href="https://github.com/josacar/triki/actions"><img src="https://github.com/josacar/triki/workflows/Crystal%20CI/badge.svg" alt="Build Status" /></a></p>
<p>You want to develop against real production data, but you don't want to violate your users' privacy.  Enter Triki: standalone Crystal code for the selective rewriting of SQL dumps in order to protect user privacy.  It supports MySQL, Postgres, and SQL Server.</p>
<h1><a id="install" class="anchor" href="#install">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Install</h1>
<p>Add this in your <code>shard.yml</code></p>
<pre><code class="language-crystal">dependencies:
  triki:
    github: josacar<span class="o">/</span>triki</code></pre>
<p>And then run <code>shards install</code></p>
<h1><a id="example-usage" class="anchor" href="#example-usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Example Usage</h1>
<p>Make an obfuscator.cr script:</p>
<pre><code class="language-crystal">require &quot;triki&quot;

obfuscator = Triki.new({
  &quot;people&quot; =&gt; {
    &quot;email&quot;                     =&gt; { :type =&gt; :email, :skip_regexes =&gt; [/^[\w\.\_]+@my_company\.com$/i] },
    &quot;ethnicity&quot;                 =&gt; :keep,
    &quot;crypted_password&quot;          =&gt; { :type =&gt; :fixed, :string =&gt; &quot;SOME_FIXED_PASSWORD_FOR_EASE_OF_DEBUGGING&quot; },
    &quot;salt&quot;                      =&gt; { :type =&gt; :fixed, :string =&gt; &quot;SOME_THING&quot; },
    &quot;remember_token&quot;            =&gt; :null,
    &quot;remember_token_expires_at&quot; =&gt; :null,
    &quot;age&quot;                       =&gt; { :type =&gt; :null, :unless =&gt; -&gt;(person : Triki::ConfigApplicator::RowAsHash) { person[&quot;email&quot;] == &quot;hello@example.com&quot; } },
    &quot;photo_file_name&quot;           =&gt; :null,
    &quot;photo_content_type&quot;        =&gt; :null,
    &quot;photo_file_size&quot;           =&gt; :null,
    &quot;photo_updated_at&quot;          =&gt; :null,
    &quot;postal_code&quot;               =&gt; { :type =&gt; :fixed, :string =&gt; &quot;94109&quot;, :unless =&gt; -&gt;(person : Triki::ConfigApplicator::RowAsHash) { person[&quot;postal_code&quot;] == &quot;12345&quot;} },
    &quot;name&quot;                      =&gt; :name,
    &quot;full_address&quot;              =&gt; :address,
    &quot;bio&quot;                       =&gt; { :type =&gt; :lorem, :number =&gt; 4 },
    &quot;relationship_status&quot;       =&gt; { :type =&gt; :fixed, :one_of =&gt; [&quot;Single&quot;, &quot;Divorced&quot;, &quot;Married&quot;, &quot;Engaged&quot;, &quot;In a Relationship&quot;] },
    &quot;has_children&quot;              =&gt; { :type =&gt; :integer, :between =&gt; 0..1 },
  },
  &quot;invites&quot;                     =&gt; :truncate,
  &quot;invite_requests&quot;             =&gt; :truncate,
  &quot;tags&quot;                        =&gt; :keep,
  &quot;relationships&quot; =&gt; {
    &quot;account_id&quot;                =&gt; :keep,
    &quot;code&quot;                      =&gt; { :type =&gt; :string, :length =&gt; 8, :chars =&gt; Triki::USERNAME_CHARS }
  }
})
obfuscator.fail_on_unspecified_columns = true # if you want it to require every column in the table to be in the above definition
obfuscator.globally_kept_columns = %w[id created_at updated_at] # if you set fail_on_unspecified_columns, you may want this as well

obfuscator.obfuscate(STDIN, STDOUT)</code></pre>
<p>And to get an obfuscated dump:</p>
<pre><code class="language-crystal">mysqldump -c --add-drop-table --hex-blob -u user -ppassword database | obfuscator &gt; obfuscated_dump.sql</code></pre>
<p>Note that the -c option on mysqldump is required to use triki.  Additionally, the default behavior of mysqldump
is to output special characters. This may cause trouble, so you can request hex-encoded blob content with <code>--hex-blob</code>.
If you get MySQL errors due to very long lines, try some combination of <code>--max_allowed_packet=128M</code>, <code>--single-transaction</code>, <code>--skip-extended-insert</code>, and <code>--quick</code>.</p>
<h2><a id="database-server" class="anchor" href="#database-server">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Database Server</h2>
<p>By default the database type is assumed to be MySQL, but you can use the builtin SQL Server support by specifying:</p>
<pre><code class="language-crystal">obfuscator.database_type <span class="o">=</span> <span class="n">:sql_server</span>
obfuscator.database_type <span class="o">=</span> <span class="n">:postgres</span></code></pre>
<p>If using Postgres, use <code>pg_dump</code> to get a dump:</p>
<pre><code class="language-crystal">pg_dump database <span class="o">|</span> obfuscator <span class="o">&gt;</span> obfuscated_dump.sql</code></pre>
<h2><a id="types" class="anchor" href="#types">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Types</h2>
<p>Available types include:</p>
<ul>
<li>email</li>
<li>string</li>
<li>lorem</li>
<li>name</li>
<li>first_name</li>
<li>last_name</li>
<li>address</li>
<li>street_address</li>
<li>secondary_address</li>
<li>city</li>
<li>state</li>
<li>zip_code</li>
<li>phone</li>
<li>company</li>
<li>ipv4</li>
<li>ipv6</li>
<li>url</li>
<li>integer</li>
<li>fixed</li>
<li>null</li>
</ul>
<p>and <code>keep</code> to keep the same value.</p>
<h2><a id="helping-with-creation-of-the-obfuscator.cr-script" class="anchor" href="#helping-with-creation-of-the-obfuscator.cr-script">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Helping with creation of the &quot;obfuscator.cr&quot; script</h2>
<p>If you don't want to type all those table names and column names into your obfuscator.cr script,
you can use triki to do some of that work for you. It can consume your database dump file and create a &quot;scaffold&quot; for the script.
To run triki in this mode, start with an &quot;empty&quot; scaffolder.cr script as follows:</p>
<pre><code class="language-crystal">obfuscator <span class="o">=</span> <span class="t">Triki</span>.new
obfuscator.scaffold(<span class="t">STDIN</span>, <span class="t">STDOUT</span>)</code></pre>
<p>Then feed in your database dump:</p>
<pre><code class="language-crystal">mysqldump -c  --hex-blob -u user -ppassword database | scaffolder &gt; obfuscator_scaffold_snippet
pg_dump database | scaffolder &gt; obfuscator_scaffold_snippet</code></pre>
<p>The output will be a series of configuration statements of the form:</p>
<pre><code class="language-crystal">  <span class="s">&quot;table_name&quot;</span> <span class="o">=&gt;</span> {
    <span class="s">&quot;column1_name&quot;</span> <span class="o">=&gt;</span> <span class="n">:keep</span>   <span class="c"># scaffold</span>
    <span class="s">&quot;column2_name&quot;</span> <span class="o">=&gt;</span> <span class="n">:keep</span>   <span class="c"># scaffold</span>
    ... etc.</code></pre>
<p>Scaffolding also works if you have a partial configuration.  If your configuration is missing some tables or some columns, a call to 'scaffold' will pass through the configuration that exists and augment it with scaffolding for the missing tables or columns.</p>
<h2><a id="speed" class="anchor" href="#speed">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Speed</h2>
<p>The main motivation to rewrite this from Ruby to Crystal was speed, here is an example obfuscating 16 tables and 15 columns in total.</p>
<h3><a id="my-sql-dump-160-mb-gziped" class="anchor" href="#my-sql-dump-160-mb-gziped">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>MySQL dump 160MB (gzip'ed)</h3>
<h4><a id="ruby" class="anchor" href="#ruby">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Ruby</h4>
<pre><code class="language-crystal">real    1m56.980s
user    1m57.080s
sys     0m2.660s</code></pre>
<h4><a id="crystal" class="anchor" href="#crystal">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Crystal</h4>
<pre><code class="language-crystal">real    0m26.579s
user    0m28.220s
sys     0m1.748s</code></pre>
<h3><a id="my-sql-dump-1.4-g" class="anchor" href="#my-sql-dump-1.4-g">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>MySQL dump 1.4G</h3>
<h4><a id="ruby-1" class="anchor" href="#ruby-1">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Ruby</h4>
<pre><code class="language-crystal">real    1m52.974s
user    1m49.824s
sys     0m4.560s</code></pre>
<h4><a id="crystal-1" class="anchor" href="#crystal-1">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Crystal</h4>
<pre><code class="language-crystal">real    0m17.642s
user    0m17.952s
sys     0m2.192s</code></pre>
<p>That's about 6.40x speedup compared to the Ruby version.</p>
<h2><a id="note-on-patchespull-requests" class="anchor" href="#note-on-patchespull-requests">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Note on Patches/Pull Requests</h2>
<ul>
<li>Fork the project.</li>
<li>Make your feature addition or bug fix.</li>
<li>Add tests for it. This is important so I don't break it in a future version unintentionally.</li>
<li>Commit, do not mess with version. (If you want to have your own version, that is fine but bump version in a commit by itself I can ignore when I pull)</li>
<li>Send me a pull request. Bonus points for topic branches.</li>
</ul>
<h2><a id="thanks" class="anchor" href="#thanks">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Thanks</h2>
<p>Forked from <a href="https://github.com/cantino/my_obfuscate">https://github.com/cantino/my_obfuscate</a></p>
<p>Thanks to all of the authors and contributors of the original Ruby gem</p>
<h2><a id="license" class="anchor" href="#license">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>LICENSE</h2>
<p>This work is provided under the MIT License.  See the included LICENSE file.</p>
<p>The included English word frequency list used for generating random text is provided under the Creative Commons â€“ Attribution / ShareAlike 3.0 license by http://invokeit.wordpress.com/frequency-word-lists/</p>
</div>
</body>
</html>
